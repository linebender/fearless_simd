<div align="center">

# Fearless SIMD Core

**Target Features in Rust's type system**

[![Latest published version.](https://img.shields.io/crates/v/fearless_simd.svg)](https://crates.io/crates/fearless_simd)
[![Documentation build status.](https://img.shields.io/docsrs/fearless_simd.svg)](https://docs.rs/fearless_simd)
[![Apache 2.0 or MIT license.](https://img.shields.io/badge/license-Apache--2.0_OR_MIT-blue.svg)](#license)
\
[![Linebender Zulip, #simd channel.](https://img.shields.io/badge/Linebender-%23simd-blue?logo=Zulip)](https://xi.zulipchat.com/#narrow/channel/514230-simd)
[![GitHub Actions CI status.](https://img.shields.io/github/actions/workflow/status/linebender/fearless_simd/ci.yml?logo=github&label=CI)](https://github.com/linebender/fearless_simd/actions)
[![Dependency staleness status.](https://deps.rs/crate/fearless_simd/latest/status.svg)](https://deps.rs/crate/fearless_simd/)

</div>

<!-- We use cargo-rdme to update the README with the contents of lib.rs.
To edit the following section, update it in lib.rs, then run:
cargo rdme --workspace-project=fearless_simd_core --heading-base-level=0
Full documentation at https://github.com/orium/cargo-rdme -->

<!-- Intra-doc links used in lib.rs should be evaluated here. 
See https://linebender.org/blog/doc-include/ for related discussion. -->

<!-- cargo-rdme start -->

An abstraction to allow safely running custom `#[target_feature]` functions on stable Rust.

This crate introduces the [`trampoline!`] macro, which allows running code in a
statically validated `#[target_feature(enable="some_features")]` environment, based on
externally provided tokens.
This abstraction is designed to be combined with target features 1.1, the recent update
in the Rust compiler to allow calling `#[target_feature]` functions safely from within
other `#[target_feature]` functions.
As such, once you have used the [`trampoline!`] macro, you can call any intrinsic in [`core::arch`].

This crate also has modules which contain tokens for each Rust target features.
These allow safely validating that a target feature is available, and obtaining a token.
These are grouped by architecture:

- [`x86`] contains the tokens for both the x86 and x86-64 targets.
  It also contains tokens for each x86-64 microarchitecture level, see [`x86::V1`] for details.
<!-- TODO: Other architectures -->

# Examples

At the time of writing, it is not possible to turn scalar values into SIMD vector types safely using
only the standard library.
These examples use [bytemuck](https://crates.io/crates/bytemuck) for this.

<!-- TODO -->

Note that for `aarch64`'s neon, you will want to enable bytemuck's `aarch64_simd` feature.
This is also the case for WASM with `wasm_simd`, but note that this crate
[isn't needed on WASM][attributes.codegen.target_feature.wasm], as it is safe to
call `#[target_features]` on that platform.

# Crate Feature Flags

<!-- TODO -->

# Implementation

The tokens provided to [`trampoline!`] implement the [`TargetFeatureToken`] trait,
which indicates that a value of that token is only possible to construct if the set
of target features it specifies are enabled.
This means that the macro can use the existence of these token values as
safety proofs that calling a function with those target features is safe.

This safety proof happens entirely in const evaluation, so if there's a mistake with the
proof, it will cause a compilation error.
The code generated by this macro is thus a function containing the provided code, marked
with `#[target_feature]`, and a call to this newly generated function.

[attributes.codegen.target_feature.wasm]: https://doc.rust-lang.org/reference/attributes/codegen.html#r-attributes.codegen.target_feature.wasm

<!-- cargo-rdme end -->

## Minimum supported Rust Version (MSRV)

This version of Fearless SIMD has been verified to compile with **Rust 1.91** and later.

Future versions of Fearless SIMD might increase the Rust version requirement.
It will not be treated as a breaking change and as such can even happen with small patch releases.

## Community

[![Linebender Zulip, #simd channel.](https://img.shields.io/badge/Linebender-%23simd-blue?logo=Zulip)](https://xi.zulipchat.com/#narrow/channel/514230-simd)

Discussion of Fearless SIMD development happens in the [Linebender Zulip](https://xi.zulipchat.com/), specifically in [#simd](https://xi.zulipchat.com/#narrow/channel/514230-simd).
All public content can be read without logging in.

Contributions are welcome by pull request.
The [Rust code of conduct] applies.

## License

Licensed under either of

- Apache License, Version 2.0 ([LICENSE-APACHE](LICENSE-APACHE) or <http://www.apache.org/licenses/LICENSE-2.0>)
- MIT license ([LICENSE-MIT](LICENSE-MIT) or <http://opensource.org/licenses/MIT>)

at your option.

[Rust Code of Conduct]: https://www.rust-lang.org/policies/code-of-conduct
